<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8/>
    <title>Plain Leaflet API</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.js'></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v3.3.1/mapbox.css' rel='stylesheet'/>
    <style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }

    </style>
</head>
<body>
<div id='map'></div>

<script>
L.mapbox.accessToken = 'pk.eyJ1IjoiaWZlZW5leSIsImEiOiJjbDRvaHJlZXgwNTNvM25udmVkbGs5Z3JrIn0.3QR9ZDt-EZQGPvlsgXYlMg';

var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=' + L.mapbox.accessToken, {
       attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
       tileSize: 512,
       zoomOffset: -1
});
var redIcon = new L.Icon({
    iconUrl: 'static/images/marker.png',
    shadowUrl: 'static/images/marker_shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});
var map = L.map('map')
  .addLayer(mapboxTiles)
  .setView([37.7212677001953, -122.160202026367], 12);

map.on('click', function(e) {
    var marker1 = L.marker([ e.latlng.lat, e.latlng.lng], {icon: redIcon}).addTo(map);

    var pt = {
      type: 'Feature',
      geometry: {
        type: 'Point',
        coordinates: [ e.latlng.lng, e.latlng.lat]
      },
      properties: {}
    };
    var buffered = turf.buffer(pt, 2.5, {units: 'miles'});
    var myLayer = L.geoJSON().addTo(map);
    myLayer.clearLayers()
    myLayer.addData(buffered);
    // clear after 5 seconds
    setTimeout(() => {
        myLayer.clearLayers();
        map.removeLayer(marker1);
    }, 5000);

});

markers_lookup = {};
var taxis = new EventSource('/topic/taxiTopic'); //ENTER YOUR TOPICNAME HERE
taxis.addEventListener('message', function(e){

    obj = JSON.parse(e.data);
    id = obj.id.id

    var markers = markers_lookup[id];
    if (typeof markers === 'undefined'){
        console.log(id + 'not found');
        markers = [];
        markers_lookup[id] = markers;
    }

    for (var i = 0; i < markers.length; i++) {
        map.removeLayer(markers[i]);
    }
    marker = L.marker([obj.position.coordinates[1], obj.position.coordinates[0]]).addTo(map);
    markers.push(marker);

}, false);

</script>
</body>
</html>